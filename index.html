<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WakeTask - Smart Alarm</title>
    <style>
        :root {
            --primary: #6366f1; /* Indigo */
            --primary-hover: #4f46e5;
            --accent: #14b8a6; /* Teal */
            --danger: #ef4444;
            --dark-bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --glass: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
            color: var(--text-main);
            min-height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- Utility Classes --- */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake-anim { animation: shake 0.2s ease-in-out 0s 2; }

        /* --- Main Container --- */
        #app-container {
            width: 100%;
            max-width: 480px;
            height: 100vh;
            position: relative;
            background: rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* --- Header / Clock --- */
        header {
            padding: 2rem 1.5rem;
            text-align: center;
        }

        .current-time {
            font-size: 4rem;
            font-weight: 200;
            letter-spacing: -2px;
            background: linear-gradient(to bottom, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .current-date {
            color: var(--text-muted);
            font-size: 1.1rem;
            margin-top: -0.5rem;
        }

        .streak-badge {
            margin-top: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 215, 0, 0.15);
            color: #ffd700;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        /* --- Alarm List --- */
        .alarm-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            scrollbar-width: none; /* Firefox */
        }
        .alarm-list::-webkit-scrollbar { display: none; /* Chrome */ }

        .alarm-card {
            background: var(--card-bg);
            border: 1px solid var(--glass);
            border-radius: 16px;
            padding: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s, background 0.2s;
        }

        .alarm-card:active { transform: scale(0.98); }

        .alarm-info h2 {
            font-size: 2rem;
            font-weight: 500;
            line-height: 1;
            margin-bottom: 5px;
        }

        .alarm-details {
            color: var(--text-muted);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* --- Controls in Card --- */
        .card-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .icon-btn {
            background: rgba(255,255,255,0.05);
            border: none;
            color: var(--text-muted);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .icon-btn.delete:hover { color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        /* --- Toggle Switch --- */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #334155;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- FAB --- */
        .fab {
            position: absolute;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0f172a;
            box-shadow: 0 10px 25px rgba(20, 184, 166, 0.4);
            cursor: pointer;
            border: none;
            transition: transform 0.2s;
            z-index: 10;
        }
        .fab:hover { transform: scale(1.1); }
        .fab svg { width: 32px; height: 32px; stroke-width: 2.5; }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex;
            align-items: flex-end; /* Mobile: bottom sheet */
            justify-content: center;
        }
        @media(min-width: 480px) {
            .modal-overlay { align-items: center; }
            .modal-content { border-radius: 24px !important; max-width: 450px; margin: 0 20px; }
        }

        .modal-content {
            background: #1e293b;
            width: 100%;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 2rem;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            border: 1px solid var(--glass);
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .modal-header h3 { font-size: 1.2rem; font-weight: 600; }

        .form-group { margin-bottom: 1.5rem; }
        label { display: block; color: var(--text-muted); margin-bottom: 0.5rem; font-size: 0.9rem; }

        input[type="time"] {
            width: 100%;
            background: #0f172a;
            border: 1px solid #334155;
            color: white;
            padding: 1rem;
            font-size: 2rem;
            border-radius: 12px;
            text-align: center;
            outline: none;
        }

        /* Custom Task Select */
        .task-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .task-option {
            background: #0f172a;
            border: 1px solid #334155;
            color: var(--text-muted);
            padding: 1rem 0.5rem;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .task-option.selected {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
            color: #a5b4fc;
        }
        .task-option svg { width: 24px; height: 24px; margin-bottom: 5px; }
        .task-option span { font-size: 0.8rem; }

        /* Volume Slider */
        input[type="range"] {
            width: 100%;
            height: 6px;
            background: #334155;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        .btn-primary {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem;
            font-size: 1.1rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }
        .btn-primary:active { transform: scale(0.98); }

        /* --- Alarm Ringing Overlay --- */
        #alarm-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #ef4444 0%, #7f1d1d 100%);
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
        }

        .bell-icon { font-size: 5rem; margin-bottom: 1rem; animation: bellShake 1s infinite; }
        @keyframes bellShake {
            0%, 100% { transform: rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(15deg); }
            20%, 40%, 60%, 80% { transform: rotate(-15deg); }
        }

        .task-container {
            background: white;
            color: #0f172a;
            padding: 2rem;
            border-radius: 20px;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }

        .task-question { font-size: 2rem; font-weight: 700; margin: 1.5rem 0; color: #1e293b; font-family: monospace;}
        
        .task-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 1rem;
        }
        .task-input:focus { border-color: var(--primary); outline: none; }
        .task-input.error { border-color: var(--danger); background: #fef2f2; }

        /* Stroop Styles */
        .stroop-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 1rem;
        }
        .stroop-btn {
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stroop-btn:active { transform: scale(0.95); }

        /* Shake Styles */
        .shake-progress-container {
            width: 100%;
            height: 24px;
            background: #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            margin: 1.5rem 0;
            border: 1px solid #cbd5e1;
        }
        .shake-bar {
            height: 100%;
            background: linear-gradient(90deg, #14b8a6, #0d9488);
            width: 0%;
            transition: width 0.1s linear;
        }
        .shake-icon { font-size: 3rem; animation: shake 1s infinite; margin-bottom: 10px; display: block; }

        /* --- Success Overlay --- */
        #success-overlay {
            background: linear-gradient(135deg, #059669 0%, #064e3b 100%);
        }
        .quote-box {
            font-style: italic;
            font-size: 1.2rem;
            line-height: 1.6;
            margin-top: 1rem;
            opacity: 0.9;
            background: rgba(255,255,255,0.1);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
        }

    </style>
</head>
<body>

    <div id="app-container">
        <!-- Header -->
        <header>
            <div class="current-time" id="clock-display">00:00</div>
            <div class="current-date" id="date-display">...</div>
            <div class="streak-badge" id="streak-display">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block; vertical-align:middle; margin-top:-2px;"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                Streak: 0 days
            </div>
        </header>

        <!-- Alarm List -->
        <div class="alarm-list" id="alarm-list"></div>

        <div id="empty-state" style="text-align: center; color: var(--text-muted); margin-top: 3rem; display: none;">
            <p style="font-size: 1.2rem;">No alarms set.</p>
            <p>Sleep well! üò¥</p>
        </div>

        <!-- FAB -->
        <button class="fab" onclick="openModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
        </button>
    </div>

    <!-- Create/Edit Modal -->
    <div id="modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add Alarm</h3>
                <button onclick="closeModal()" style="background:none; border:none; color:var(--text-muted); cursor:pointer;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            
            <div class="form-group">
                <label>Wake Up Time</label>
                <input type="time" id="input-time">
            </div>

            <div class="form-group">
                <label>Wake Up Task</label>
                <div class="task-grid">
                    <div class="task-option selected" onclick="selectTask('math')" id="opt-math">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>
                        <span>Math</span>
                    </div>
                    <div class="task-option" onclick="selectTask('stroop')" id="opt-stroop">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="10.5" r="2.5"/><circle cx="8.5" cy="7.5" r="2.5"/><circle cx="6.5" cy="12.5" r="2.5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg>
                        <span>Color Test</span>
                    </div>
                    <div class="task-option" onclick="selectTask('shake')" id="opt-shake">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>
                        <span>Shake</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div style="display:flex; justify-content:space-between; color:var(--text-muted); font-size:0.9rem; margin-bottom:0.5rem;">
                    <label style="margin:0;">Alarm Volume</label>
                    <span id="vol-display">100%</span>
                </div>
                <input type="range" id="input-volume" min="10" max="100" value="100" oninput="updateVolDisplay(this.value)">
            </div>

            <button class="btn-primary" onclick="saveAlarm()" id="btn-save">Set Alarm</button>
        </div>
    </div>

    <!-- Ringing Overlay -->
    <div id="alarm-overlay" class="hidden">
        <div class="bell-icon">üîî</div>
        <h1 style="color:white; margin-bottom:20px; font-size: 3rem;">WAKE UP!</h1>
        
        <!-- Task Container (Content Injected via JS) -->
        <div id="task-container" class="task-container"></div>
    </div>

    <!-- Success Overlay -->
    <div id="success-overlay" class="modal-overlay hidden" style="flex-direction: column; align-items: center; justify-content: center; text-align: center; color: white;">
        <div style="font-size: 4rem;">‚òÄÔ∏è</div>
        <h1 style="font-size: 2.5rem; margin: 10px 0;">Good Morning!</h1>
        <p style="color: #a7f3d0; margin-bottom: 2rem;">You're up and ready to go.</p>
        <div style="padding: 0 2rem; width: 100%;">
            <p class="quote-box" id="success-quote">"The future belongs to those who believe in the beauty of their dreams."</p>
        </div>
        <button style="background: white; color: #059669; padding: 1rem 3rem; border: none; border-radius: 50px; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2);" onclick="dismissSuccess()">Start My Day</button>
    </div>

    <script>
        // --- State ---
        let alarms = JSON.parse(localStorage.getItem('waketask_alarms')) || [];
        let streak = parseInt(localStorage.getItem('waketask_streak')) || 0;
        
        let editingId = null;
        let selectedTaskType = 'math';
        
        let activeAlarm = null;
        let currentMathAnswer = null;
        let currentStroopAnswer = null; // color string
        
        // Shake State
        let shakeProgress = 0;
        let shakeHandler = null;

        // Audio
        let audioCtx = null;
        let oscillator = null;
        let gainNode = null;
        let beepInterval = null;

        const quotes = [
            "Your limitation‚Äîit's only your imagination.",
            "Push yourself, because no one else is going to do it for you.",
            "Great things never come from comfort zones.",
            "Dream it. Wish it. Do it.",
            "Success doesn't just find you. You have to go out and get it."
        ];

        // --- Elements ---
        const els = {
            clock: document.getElementById('clock-display'),
            date: document.getElementById('date-display'),
            streak: document.getElementById('streak-display'),
            list: document.getElementById('alarm-list'),
            empty: document.getElementById('empty-state'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            inpTime: document.getElementById('input-time'),
            inpVol: document.getElementById('input-volume'),
            volDisp: document.getElementById('vol-display'),
            btnSave: document.getElementById('btn-save'),
            overlay: document.getElementById('alarm-overlay'),
            taskContainer: document.getElementById('task-container'),
            success: document.getElementById('success-overlay'),
            quote: document.getElementById('success-quote'),
            optMath: document.getElementById('opt-math'),
            optStroop: document.getElementById('opt-stroop'),
            optShake: document.getElementById('opt-shake')
        };

        // --- Initialization ---
        function init() {
            renderAlarms();
            updateClock();
            updateStreakUI();
            setInterval(updateClock, 1000);
        }

        function updateStreakUI() {
            els.streak.innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block; vertical-align:middle; margin-top:-2px;"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                Streak: ${streak} days
            `;
        }

        function updateClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2,'0');
            const m = String(now.getMinutes()).padStart(2,'0');
            els.clock.textContent = `${h}:${m}`;
            els.date.textContent = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

            if (now.getSeconds() === 0 && !activeAlarm) {
                const timeStr = `${h}:${m}`;
                const match = alarms.find(a => a.time === timeStr && a.enabled);
                if (match) triggerAlarm(match);
            }
        }

        // --- Audio System ---
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(volPercent) {
            initAudio();
            const maxGain = volPercent / 100;
            oscillator = audioCtx.createOscillator();
            gainNode = audioCtx.createGain();
            
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            gainNode.gain.setValueAtTime(0.01, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(Math.max(0.01, maxGain), audioCtx.currentTime + 0.5);

            oscillator.start();
            let isHigh = false;
            beepInterval = setInterval(() => {
                if(!oscillator) return;
                const freq = isHigh ? 440 : 880;
                try { oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime); } catch(e){}
                isHigh = !isHigh;
            }, 500);
        }

        function stopSound() {
            if (oscillator) {
                try { oscillator.stop(); oscillator.disconnect(); } catch(e){}
                oscillator = null;
            }
            if (beepInterval) {
                clearInterval(beepInterval);
                beepInterval = null;
            }
            // Cleanup shake
            if (shakeHandler) {
                window.removeEventListener('devicemotion', shakeHandler);
                shakeHandler = null;
            }
        }

        // --- Alarm & Tasks ---
        function triggerAlarm(alarm) {
            activeAlarm = alarm;
            els.overlay.classList.remove('hidden');
            playSound(alarm.volume || 100);

            // Render specific task UI
            els.taskContainer.innerHTML = ''; // clear previous
            
            if (alarm.taskType === 'math') {
                renderMathTask();
            } else if (alarm.taskType === 'stroop') {
                renderStroopTask();
            } else if (alarm.taskType === 'shake') {
                renderShakeTask();
            }
        }

        function completeTask() {
            stopSound();
            activeAlarm = null;
            els.overlay.classList.add('hidden');
            streak++;
            localStorage.setItem('waketask_streak', streak);
            updateStreakUI();
            els.quote.textContent = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;
            els.success.classList.remove('hidden');
        }

        // 1. Math Task
        function renderMathTask() {
            const ops = ['+', '-', '*'];
            const op = ops[Math.floor(Math.random() * ops.length)];
            let n1 = Math.floor(Math.random() * 20) + 5;
            let n2 = Math.floor(Math.random() * 10) + 1;
            if(op === '*') n1 = Math.floor(Math.random() * 12);

            let ans = 0;
            if(op === '+') ans = n1 + n2; else if(op === '-') ans = n1 - n2; else if(op === '*') ans = n1 * n2;
            currentMathAnswer = ans.toString();

            els.taskContainer.innerHTML = `
                <h3 style="color:#64748b; text-transform:uppercase; font-size:0.8rem; letter-spacing:1px; font-weight:700;">Complete to Stop</h3>
                <div class="task-question">${n1} ${op} ${n2} = ?</div>
                <input type="number" id="math-input" class="task-input" placeholder="?" autocomplete="off">
                <button class="btn-primary" onclick="checkMath()">Submit</button>
            `;
            
            // Focus logic
            setTimeout(() => document.getElementById('math-input').focus(), 100);
            document.getElementById('math-input').addEventListener('keyup', (e) => {
                if(e.key === 'Enter') checkMath();
            });
        }

        function checkMath() {
            const inp = document.getElementById('math-input');
            if (inp.value.trim() === currentMathAnswer) {
                completeTask();
            } else {
                inp.classList.add('error');
                inp.value = '';
                setTimeout(() => inp.classList.remove('error'), 500);
            }
        }

        // 2. Stroop Task
        function renderStroopTask() {
            const colors = ['red', 'blue', 'green', 'yellow', 'purple', 'orange'];
            const colorMap = {
                'red': '#ef4444', 'blue': '#3b82f6', 'green': '#22c55e', 
                'yellow': '#eab308', 'purple': '#a855f7', 'orange': '#f97316'
            };
            
            // Pick word and ink
            const wordIdx = Math.floor(Math.random() * colors.length);
            let inkIdx = Math.floor(Math.random() * colors.length);
            // Ensure ink is different from word for challenge
            while(inkIdx === wordIdx) { inkIdx = Math.floor(Math.random() * colors.length); }

            const wordText = colors[wordIdx].toUpperCase();
            const inkColor = colors[inkIdx];
            currentStroopAnswer = inkColor; // The correct answer is the INK COLOR

            // Pick 4 options including correct one
            let options = [inkColor];
            while(options.length < 4) {
                const c = colors[Math.floor(Math.random() * colors.length)];
                if(!options.includes(c)) options.push(c);
            }
            options.sort(() => Math.random() - 0.5); // Shuffle

            let btnsHtml = options.map(c => 
                `<button class="stroop-btn" style="background:${colorMap[c]}" onclick="checkStroop('${c}')">${c}</button>`
            ).join('');

            els.taskContainer.innerHTML = `
                <h3 style="color:#64748b; font-weight:700;">TAP THE <span style="text-decoration:underline;">COLOR</span>, NOT WORD</h3>
                <div class="task-question" style="color:${colorMap[inkColor]}; font-size:3.5rem;">${wordText}</div>
                <div class="stroop-grid">${btnsHtml}</div>
            `;
        }

        function checkStroop(color) {
            if (color === currentStroopAnswer) {
                completeTask();
            } else {
                // Wrong: Generate new Stroop to discourage guessing
                const q = document.querySelector('.task-question');
                q.classList.add('shake-anim');
                setTimeout(() => {
                    q.classList.remove('shake-anim');
                    renderStroopTask(); // Refresh
                }, 400);
            }
        }

        // 3. Shake Task
        function renderShakeTask() {
            shakeProgress = 0;
            els.taskContainer.innerHTML = `
                <div style="text-align:center;">
                    <div class="shake-icon">üì≥</div>
                    <h3 style="color:#64748b; font-weight:700;">SHAKE PHONE VIGOROUSLY</h3>
                    <div class="shake-progress-container">
                        <div id="shake-bar" class="shake-bar"></div>
                    </div>
                    <button id="perm-btn" class="btn-primary hidden" onclick="requestShakePerm()">Enable Sensor</button>
                    <p style="color:#94a3b8; font-size:0.9rem; margin-top:10px;">Keep shaking to fill the bar!</p>
                </div>
            `;

            // Check iOS 13+ permission requirement
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                document.getElementById('perm-btn').classList.remove('hidden');
                document.querySelector('.shake-icon').style.display = 'none'; // hide animation until started
            } else {
                startShakeDetection();
            }
        }

        function requestShakePerm() {
            DeviceMotionEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        document.getElementById('perm-btn').classList.add('hidden');
                        document.querySelector('.shake-icon').style.display = 'block';
                        startShakeDetection();
                    } else {
                        alert("Permission needed to stop alarm!");
                    }
                })
                .catch(console.error);
        }

        function startShakeDetection() {
            let lastX = 0, lastY = 0, lastZ = 0;
            let lastUpdate = 0;

            shakeHandler = (event) => {
                const current = event.accelerationIncludingGravity;
                if(!current) return;

                const curTime = Date.now();
                if ((curTime - lastUpdate) > 100) {
                    const diffTime = curTime - lastUpdate;
                    lastUpdate = curTime;

                    const speed = Math.abs(current.x + current.y + current.z - lastX - lastY - lastZ) / diffTime * 10000;

                    if (speed > 300) { // Threshold
                        shakeProgress += 4; // Increment
                        if(shakeProgress > 100) shakeProgress = 100;
                        document.getElementById('shake-bar').style.width = shakeProgress + '%';
                        
                        if (shakeProgress >= 100) {
                            window.removeEventListener('devicemotion', shakeHandler);
                            completeTask();
                        }
                    } else {
                        // Decay if not shaking
                        if(shakeProgress > 0) shakeProgress -= 0.5;
                        document.getElementById('shake-bar').style.width = shakeProgress + '%';
                    }

                    lastX = current.x;
                    lastY = current.y;
                    lastZ = current.z;
                }
            };
            window.addEventListener('devicemotion', shakeHandler);
        }


        // --- UI & CRUD ---
        function selectTask(type) {
            selectedTaskType = type;
            // Reset
            [els.optMath, els.optStroop, els.optShake].forEach(el => el.classList.remove('selected'));
            // Set
            if(type === 'math') els.optMath.classList.add('selected');
            if(type === 'stroop') els.optStroop.classList.add('selected');
            if(type === 'shake') els.optShake.classList.add('selected');
        }

        function renderAlarms() {
            els.list.innerHTML = '';
            if (alarms.length === 0) {
                els.empty.style.display = 'block';
                return;
            }
            els.empty.style.display = 'none';
            alarms.sort((a,b) => a.time.localeCompare(b.time));

            alarms.forEach(alarm => {
                const div = document.createElement('div');
                div.className = 'alarm-card fade-in';
                
                const [h, m] = alarm.time.split(':');
                const d = new Date(); d.setHours(h); d.setMinutes(m);
                const timeStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // Icons logic
                let iconSvg = '';
                if(alarm.taskType === 'math') iconSvg = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>';
                else if(alarm.taskType === 'stroop') iconSvg = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="10.5" r="2.5"/><circle cx="8.5" cy="7.5" r="2.5"/><circle cx="6.5" cy="12.5" r="2.5"/></svg>';
                else if(alarm.taskType === 'shake') iconSvg = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>';

                div.innerHTML = `
                    <div class="alarm-info">
                        <h2>${timeStr}</h2>
                        <div class="alarm-details">
                            ${iconSvg}
                            <span>${alarm.taskType.toUpperCase()}</span>
                            <span style="opacity:0.5">|</span>
                            <span>${alarm.volume || 100}%</span>
                        </div>
                    </div>
                    <div class="card-controls">
                        <button class="icon-btn" onclick="editAlarm(${alarm.id})">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                        </button>
                        <label class="switch">
                            <input type="checkbox" ${alarm.enabled ? 'checked' : ''} onchange="toggleAlarm(${alarm.id})">
                            <span class="slider"></span>
                        </label>
                        <button class="icon-btn delete" onclick="deleteAlarm(${alarm.id})">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                `;
                els.list.appendChild(div);
            });
        }

        // --- Standard CRUD/Modal Functions (Unchanged Logic) ---
        function openModal() {
            editingId = null;
            els.modalTitle.textContent = "Add Alarm";
            els.btnSave.textContent = "Set Alarm";
            const now = new Date(); now.setMinutes(now.getMinutes()+1);
            els.inpTime.value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            selectTask('math');
            els.inpVol.value = 100; updateVolDisplay(100);
            els.modal.classList.remove('hidden');
        }

        function editAlarm(id) {
            const alarm = alarms.find(a => a.id === id);
            if (!alarm) return;
            editingId = id;
            els.modalTitle.textContent = "Edit Alarm";
            els.btnSave.textContent = "Save Changes";
            els.inpTime.value = alarm.time;
            selectTask(alarm.taskType);
            els.inpVol.value = alarm.volume || 100; updateVolDisplay(alarm.volume || 100);
            els.modal.classList.remove('hidden');
        }

        function saveAlarm() {
            const time = els.inpTime.value;
            if(!time) return;
            const vol = parseInt(els.inpVol.value);
            if (editingId) {
                const idx = alarms.findIndex(a => a.id === editingId);
                if (idx !== -1) {
                    alarms[idx].time = time;
                    alarms[idx].taskType = selectedTaskType;
                    alarms[idx].volume = vol;
                }
            } else {
                alarms.push({ id: Date.now(), time: time, taskType: selectedTaskType, volume: vol, enabled: true });
            }
            localStorage.setItem('waketask_alarms', JSON.stringify(alarms));
            renderAlarms();
            closeModal();
            initAudio();
        }

        function deleteAlarm(id) {
            if(!confirm('Delete?')) return;
            alarms = alarms.filter(a => a.id !== id);
            localStorage.setItem('waketask_alarms', JSON.stringify(alarms));
            renderAlarms();
        }
        function toggleAlarm(id) {
            const idx = alarms.findIndex(a => a.id === id);
            if (idx !== -1) {
                alarms[idx].enabled = !alarms[idx].enabled;
                localStorage.setItem('waketask_alarms', JSON.stringify(alarms));
                renderAlarms();
            }
        }
        function closeModal() { els.modal.classList.add('hidden'); }
        function updateVolDisplay(val) { els.volDisp.textContent = val + "%"; }
        function dismissSuccess() { els.success.classList.add('hidden'); init(); }
        els.modal.addEventListener('click', (e) => { if (e.target === els.modal) closeModal(); });

        init();
    </script>
</body>
</html>
